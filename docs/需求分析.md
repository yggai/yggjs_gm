## 国密算法 TypeScript 开源库 — 需求分析（PRD）

- 文档版本：v1.0
- 撰写角色：产品经理（PM）
- 面向读者：技术负责人、架构师、前/后端工程师、测试、文档与社区维护者
- 更新时间：2025-08-15

### 1. 背景与目标
- 背景：金融、政务与信创环境要求采用国密算法（SM2/SM3/SM4）。前端/Node 生态缺少高质量、易用、跨平台的 TS 实现。
- 目标：提供现代、强类型、跨运行时（Node/Web/Bun/Deno/RN）的国密算法库，降低接入与合规成本。
- **生态体系愿景**：构建跨语言国密算法生态，包含 JavaScript（yggjs_gm）、Python（yggpy_gm）、Golang（ygggo_gm）三大框架，实现跨语言密码互操作性。
- 成功标准：
  - 10 分钟完成首个签名/验签或加解密 Demo（Must）
  - 覆盖常用国密算法场景（Must）
  - 完整文档/示例/测试/CI（Must）
  - 具备良好性能与安全默认值（Should）
  - **跨语言兼容性**：与 yggpy_gm、ygggo_gm 实现密码学互操作（Must）

### 2. 用户画像与使用场景
- 用户画像：
  - 前端工程师（Web/H5/混合容器）（Must）
  - Node.js 后端工程师（Must）
  - 跨端团队（React Native/Electron）（Should）
  - 安全合规工程师（Should）
  - **多语言技术栈团队**：需要在 JS/Python/Go 间进行密码学互操作的团队（Must）
- 场景：
  - SM2 签名/验签用于接口签名、电子合同、票据（Must）
  - SM2 加密/解密用于敏感数据传输（Should）
  - SM3 摘要与 HMAC-SM3 用于完整性校验（Must/Should）
  - SM4 对称加解密（CBC/CTR 等）用于数据存储与传输（Must）
  - 与 SM2 证书/CSR/PKI 互操作（Should）
  - **跨语言密码互操作**：
    - JavaScript 前端加密，Python/Go 后端解密（Must）
    - Go 微服务签名，JavaScript 前端验签（Must）
    - Python 数据处理系统与 JavaScript 应用间的密钥交换（Should）
    - 多语言系统间的统一身份认证与授权（Should）

### 3. 术语与合规声明
- 术语：SM2（椭圆曲线公钥密码）、SM3（杂凑/哈希）、SM4（分组对称密码）。
- 合规声明：本库为通用开源实现，不等同权威认证；生产合规需结合经认证模块或通过合规测试。

### 4. 产品范围（Scope）
- In Scope（本期）：
  - SM2：签名/验签（Must），加密/解密（Should）
  - SM3：摘要（Must），HMAC-SM3（Should）
  - SM4：ECB/CBC/CTR/CFB/OFB（Must），流式接口（Should）
  - 随机数：安全随机源封装（Must）
  - 密钥管理：生成/导入/导出（JWK/PEM/DER）（Must）
  - API：Promise 风格、强类型、友好错误（Must）
  - 打包：ESM/CJS、Tree-shaking、轻量体积（Must）
  - 文档/示例/Typedoc、CI（Must）
  - **跨语言兼容性**：
    - 与 yggpy_gm（Python）、ygggo_gm（Golang）的密码学格式兼容（Must）
    - 统一的密钥格式与编码标准（JWK/PEM/DER）（Must）
    - 一致的算法参数与默认值（曲线参数、填充模式、编码格式）（Must）
    - 跨语言测试向量与验证套件（Must）
- Out of Scope（本期不做）：
  - SM9、ZUC、TLS/GMSSL 全栈（Could）
  - 完整 PKI 工具链（高级证书操作）（Could）
  - 硬件加速/HSM/KMS 专用适配（预留接口）（Should/Could）

### 5. 功能需求（详细）
- 5.1 SM2（sm2p256v1）
  - 签名/验签：DER/RS 编码，可配置哈希（默认 SM3）（Must）
  - 加密/解密：C1C2C3 与 C1C3C2 编码（Should）；可选标签/盐（Could）
  - 密钥：生成、JWK/PKCS8/SPKI/PEM/DER 导入导出（Must）
  - 证书：基础的公钥/证书解析与使用（Should）
- 5.2 SM3
  - 摘要：字节/流式输入，输出 256-bit（Must）
  - HMAC-SM3：密钥化哈希（Should）
- 5.3 SM4
  - 模式：ECB/CBC/CTR/CFB/OFB（Must）
  - 填充：PKCS#7/None（Must），Zero/ISO10126（Could）
  - AEAD：GCM/CCM（研究性，若提供需注明兼容性）（Could）
  - 流式加解密（Node 流/浏览器分片）（Should）
- 5.4 随机数与可插拔
  - Web Crypto getRandomValues/Node crypto.randomBytes 封装（Must）
  - 自定义 RNG 注入（测试/硬件对接）（Should）
- 5.5 密钥与格式
  - JWK、PEM、DER（PKCS#8、SPKI）互转（Must）
  - 私钥保护（加密 PEM，可选）（Should）
- 5.6 API 设计
  - 统一命名：gm.sm2 / gm.sm3 / gm.sm4 / gm.random（Must）
  - 数据统一 Uint8Array/ArrayBuffer；便捷字符串包装（Should）
  - 结构化错误：GmError(code,message,cause?)（Must）
- 5.7 跨语言兼容性
  - **标准化格式**：与 yggpy_gm、ygggo_gm 保持一致的密钥格式（JWK/PEM/DER）（Must）
  - **算法参数统一**：相同的椭圆曲线参数、填充模式、编码方式（Must）
  - **测试向量共享**：三个框架使用相同的标准测试向量进行验证（Must）
  - **互操作测试**：
    - JS 加密 → Python/Go 解密（Must）
    - Python/Go 签名 → JS 验签（Must）
    - 密钥在三种语言间的导入导出（Must）
  - **版本同步**：重大算法更新时，三个框架保持版本同步（Should）

### 6. 非功能需求
- 安全（Must）
  - 尽量常数时间路径；避免侧信道（在 JS 可控范围内）
  - 安全默认值（曲线/模式/填充）；敏感数据尽可能清零
  - 明确风险提示（如 ECB 风险、IV/nonce 规范）
- 性能（Should）
  - Node 目标：SM3 ≥ 300 MB/s；SM4-CTR ≥ 400 MB/s（参考值）
  - Browser 目标：SM3 ≥ 50 MB/s；SM4-CTR ≥ 80 MB/s
  - 提供基准脚本与报告
- 兼容性（Must）
  - 运行时：Node LTS、现代浏览器、Bun、Deno（Must）；React Native（Should）
  - 模块：ESM 优先，兼容 CJS；TS 严格模式
- 可靠性（Must）
  - 单元测试覆盖率 ≥ 90%；标准向量与交叉验证
  - 语义化版本与变更日志
  - **跨语言一致性测试**：与 yggpy_gm、ygggo_gm 的互操作性验证
- 可用性（Should）
  - API 简洁、错误可读、文档可搜索

### 7. 技术方案（初稿）
- 分层架构（Must）
  - 核心算法层：纯 TS 实现 + 可插拔后端（WebCrypto/WASM/Native）
  - 适配层：运行时能力探测与选择
  - 友好 API 层：高阶封装（encryptString/decryptString、证书便捷导入）
- 实现与后端（Must/Should）
  - Node 原生 crypto 不含国密，默认使用 TS/WASM 实现
  - WASM（Rust）作为性能路径（后续引入）（Should）
  - 可选 @napi-rs/Node-API 原生插件（企业需求）（Could）
- 构建发布（Must）
  - tsup/rollup 产出 ESM/CJS/类型，支持 Tree-shaking
  - 条件导出与副作用声明，浏览器/Node 双友好包
- 类型与文档（Must）
  - TS strict，TSDoc 注释，Typedoc 站点

### 8. API 草案（示例）
- gm.sm2.sign(privateKey, data, opts?) → signature
- gm.sm2.verify(publicKey, data, signature, opts?) → boolean
- gm.sm2.encrypt(publicKey, plaintext, opts?) → ciphertext
- gm.sm2.decrypt(privateKey, ciphertext, opts?) → plaintext
- gm.sm3.digest(data) → hash；gm.sm3.hmac(key, data) → mac
- gm.sm4.encrypt(key, iv, data, {mode:'CBC'|'CTR'..., padding:'PKCS7'|'None'})
- gm.sm4.decrypt(key, iv, data, options)
- gm.key.generate({alg:'SM2'|'SM4', length?}); gm.key.import/export(...)
- gm.random.bytes(length) → Uint8Array

### 9. 文档与开发者体验（DX）
- 结构：快速开始、算法指南、API 参考、Cookbook、FAQ、安全指南（Must）
- 示例：浏览器与 Node 双环境，Vite/Webpack 配置示例（Must）
- 教程：JWK/PEM/DER 与证书互操作、生产加固（Should）

### 10. 测试与验收
- 测试（Must）：
  - 单元测试（算法与边界）、标准向量测试、交叉验证
  - 端到端（浏览器+Node 的签名验签、加解密关键路径）
  - 基准测试（不同输入大小与模式）
  - **跨语言互操作测试**：
    - yggjs_gm ↔ yggpy_gm 密码学互操作验证
    - yggjs_gm ↔ ygggo_gm 密码学互操作验证
    - 三框架间的密钥格式兼容性测试
    - 统一测试向量在三个框架中的一致性验证
- 验收（Must）：
  - 功能覆盖达成 In Scope 列表；覆盖率 ≥ 90%
  - CI 通过：Node LTS、主流浏览器矩阵
  - **跨语言兼容性验收**：与 yggpy_gm、ygggo_gm 的核心算法互操作 100% 通过

### 11. 版本规划与里程碑（建议）
- v0.1（MVP，4–6 周）：SM3、SM4 CBC/CTR、随机数、基础密钥导入导出、基础文档与测试
- v0.2（6–10 周）：SM2 签名/验签、SM4 其他模式、HMAC-SM3、错误体系、更多测试向量、基准
- v0.3（8–12 周）：SM2 加密/解密、证书/格式增强、流式 API、浏览器与 RN 兼容性强化
- v0.4+：WASM 性能后端、硬件/企业适配、AEAD 研究、SM2 密钥交换、文档站完善

### 12. 风险与缓解
- 算法正确性：权威向量+交叉验证+代码评审（Must）
- 性能不足：WASM 后端、热点优化、减少复制、批处理接口（Should）
- 打包兼容：多目标构建、条件导出、示例仓库验证、E2E 矩阵（Must）
- 合规误用：文档注记、默认安全参数、显式警告（Must）
- **跨语言兼容性风险**：
  - 算法实现差异：建立统一的算法规范文档，定期同步三个框架的实现（Must）
  - 格式不兼容：制定严格的数据格式标准，建立跨语言测试矩阵（Must）
  - 版本不同步：建立版本发布协调机制，重大更新时三框架同步发布（Should）
  - 性能差异：建立跨语言性能基准，确保核心算法性能在合理范围内（Should）

### 13. 开源与治理
- 许可证：MIT 或 Apache-2.0（建议 Apache-2.0，便于企业采用）（Must）
- 版本策略：SemVer；提交规范：Conventional Commits（Should）
- 贡献流程：Issue/PR 模板、Code of Conduct、贡献指南（Must）
- CI/CD：GitHub Actions（测试+构建+质量检查）（Must）

### 14. 未来扩展（路线图）
- SM9、国密 TLS/GMSSL 适配器
- HSM/KMS/加密机对接抽象层
- 丰富证书与 PKI 工具链（CSR、CRL、OCSP）
- 浏览器原生国密能力出现后的自动切换与降级策略
- **跨语言生态扩展**：
  - 建立统一的国密算法标准规范文档
  - 开发跨语言的密钥管理与交换协议
  - 构建多语言统一的 PKI 工具链
  - 支持更多编程语言（Rust、Java、C# 等）
  - 建立跨语言的性能基准与优化指南

### 15. 跨语言生态架构
- **核心理念**：三个框架（yggjs_gm、yggpy_gm、ygggo_gm）作为统一生态的组成部分，确保密码学算法的完全互操作性
- **技术标准**：
  - 统一的算法参数与实现标准
  - 一致的密钥格式与编码规范
  - 共享的测试向量与验证套件
  - 同步的版本发布与更新机制
- **应用场景**：
  - 微服务架构中不同语言服务间的安全通信
  - 前后端分离应用的端到端加密
  - 多语言数据处理管道的安全保障
  - 跨平台应用的统一身份认证

— 完 —