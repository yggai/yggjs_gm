# 国密算法 TypeScript 库技术选型

- **文档版本**: v1.0
- **撰写角色**: 前端架构师
- **面向读者**: 技术决策者、项目经理、核心开发者
- **更新时间**: 2025-08-15

## 1. 选型原则与策略

### 1.1 核心原则

- **安全第一**: 核心密码学算法必须自主可控，确保安全性
- **性能优先**: 关键路径优化，支持高并发场景
- **兼容性**: 跨平台、跨语言兼容，与 yggpy_gm、ygggo_gm 互操作
- **可维护性**: 代码清晰、文档完善、测试覆盖率高
- **生态友好**: 与现有 JavaScript 生态无缝集成

### 1.2 选型策略

```
自研 vs 第三方决策矩阵:

                    自研    第三方   推荐方案
核心算法 (SM2/3/4)   ✅      ❌      自研
数学基础库           ⚠️      ✅      混合
密码学工具           ⚠️      ⚠️      自研+复用
构建工具链           ❌      ✅      第三方
测试框架             ❌      ✅      第三方
文档工具             ❌      ✅      第三方
开发工具             ❌      ✅      第三方
性能优化             ✅      ⚠️      自研+第三方
```

## 2. 核心算法实现

### 2.1 国密算法 (SM2/SM3/SM4)

**选型决策**: 🔴 **完全自研**

**理由分析**:
- ✅ **安全可控**: 避免第三方库的安全风险和后门
- ✅ **跨语言兼容**: 与 Python/Go 版本保持算法一致性
- ✅ **性能优化**: 针对 JavaScript 特性优化
- ✅ **体积控制**: 避免不必要的功能，减小包体积
- ❌ **开发成本**: 需要深入理解密码学原理

**实施方案**:
```typescript
// 自研核心算法模块
src/core/
├── sm2/           # SM2 椭圆曲线算法
├── sm3/           # SM3 哈希算法  
├── sm4/           # SM4 分组密码算法
└── math/          # 数学基础运算
```

**风险控制**:
- 使用权威测试向量验证正确性
- 代码审计和安全评估
- 与标准实现交叉验证

## 3. 数学基础库

### 3.1 大数运算库

**选型对比**:

| 库名 | 大小 | 性能 | 维护状态 | TypeScript | 推荐度 |
|------|------|------|----------|------------|--------|
| **big-integer** | 25KB | ⭐⭐⭐⭐ | 活跃 | ✅ | 🟢 推荐 |
| bn.js | 35KB | ⭐⭐⭐⭐⭐ | 活跃 | ⚠️ | 🟡 备选 |
| jsbn | 15KB | ⭐⭐⭐ | 停维护 | ❌ | 🔴 不推荐 |
| 原生 BigInt | 0KB | ⭐⭐⭐⭐⭐ | 原生 | ✅ | 🟢 优先 |

**最终选择**: 🟢 **原生 BigInt + big-integer 补充**

```typescript
// 优先使用原生 BigInt
const a = 123n;
const b = 456n;
const result = a * b;

// 复杂运算使用 big-integer
import bigInt from 'big-integer';
const modInverse = bigInt(a).modInv(p);
```

### 3.2 椭圆曲线运算

**选型决策**: 🔴 **自研**

**理由**:
- 现有库不支持 SM2 曲线参数
- 需要常数时间实现防止侧信道攻击
- 与 Python/Go 版本保持一致的点表示

## 4. 密码学工具库

### 4.1 现有密码学库分析

| 库名 | 国密支持 | 体积 | 维护状态 | 推荐度 |
|------|----------|------|----------|--------|
| crypto-js | ❌ | 150KB | 活跃 | 🔴 不适用 |
| node-forge | ❌ | 200KB | 活跃 | 🔴 不适用 |
| webcrypto-core | ❌ | 80KB | 活跃 | 🔴 不适用 |
| js-crypto-utils | ❌ | 120KB | 一般 | 🔴 不适用 |

**选型决策**: 🔴 **自研核心 + 复用工具**

**实施策略**:
```typescript
// 自研核心算法
import { sm2, sm3, sm4 } from './core';

// 复用编码转换工具
import { Buffer } from 'buffer'; // Node.js Buffer polyfill
import { encode, decode } from 'base64-arraybuffer';
```

## 5. 构建工具链

### 5.1 构建工具对比

| 工具 | 构建速度 | 配置复杂度 | TypeScript | Tree-shaking | 推荐度 |
|------|----------|------------|------------|--------------|--------|
| **tsup** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ✅ | ✅ | 🟢 开发首选 |
| rollup | ⭐⭐⭐⭐ | ⭐⭐⭐ | ✅ | ✅ | 🟢 生产首选 |
| webpack | ⭐⭐⭐ | ⭐⭐ | ✅ | ✅ | 🟡 备选 |
| vite | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ✅ | ✅ | 🟡 备选 |

**最终选择**: 🟢 **tsup (开发) + rollup (生产)**

```javascript
// tsup.config.ts - 开发构建
export default defineConfig({
  entry: ['src/index.ts'],
  format: ['esm', 'cjs'],
  dts: true,
  clean: true,
  splitting: true
});

// rollup.config.js - 生产构建
export default {
  input: 'src/index.ts',
  output: [
    { file: 'dist/index.esm.js', format: 'esm' },
    { file: 'dist/index.cjs.js', format: 'cjs' }
  ],
  plugins: [typescript(), terser()]
};
```

### 5.2 包管理器选择

**选型对比**:

| 包管理器 | 安装速度 | 磁盘占用 | Monorepo | 推荐度 |
|----------|----------|----------|----------|--------|
| **pnpm** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ✅ | 🟢 推荐 |
| yarn | ⭐⭐⭐⭐ | ⭐⭐⭐ | ✅ | 🟡 备选 |
| npm | ⭐⭐⭐ | ⭐⭐ | ⚠️ | 🟡 备选 |

**最终选择**: 🟢 **pnpm**

## 6. 测试框架

### 6.1 测试框架对比

| 框架 | 执行速度 | TypeScript | ESM | 配置复杂度 | 推荐度 |
|------|----------|------------|-----|------------|--------|
| **Vitest** | ⭐⭐⭐⭐⭐ | ✅ | ✅ | ⭐⭐⭐⭐⭐ | 🟢 推荐 |
| Jest | ⭐⭐⭐ | ✅ | ⚠️ | ⭐⭐⭐ | 🟡 备选 |
| Mocha | ⭐⭐⭐⭐ | ✅ | ✅ | ⭐⭐ | 🟡 备选 |

**最终选择**: 🟢 **Vitest + Playwright**

```typescript
// vitest.config.ts
export default defineConfig({
  test: {
    globals: true,
    environment: 'node',
    coverage: {
      provider: 'v8',
      threshold: { global: { lines: 90 } }
    }
  }
});
```

### 6.2 E2E 测试

**选型**: 🟢 **Playwright**
- 跨浏览器支持
- 现代 API 设计
- 优秀的调试体验

## 7. 文档工具

### 7.1 API 文档

**选型**: 🟢 **TypeDoc**
- TypeScript 原生支持
- 自动生成 API 文档
- 主题丰富

### 7.2 用户文档

**选型**: 🟢 **VitePress**
- Vue 生态，性能优秀
- Markdown 支持
- 现代化 UI

## 8. 开发工具

### 8.1 代码质量

| 工具 | 功能 | 配置复杂度 | 推荐度 |
|------|------|------------|--------|
| **ESLint** | 代码检查 | ⭐⭐⭐ | 🟢 必需 |
| **Prettier** | 代码格式化 | ⭐⭐⭐⭐⭐ | 🟢 必需 |
| **Husky** | Git hooks | ⭐⭐⭐⭐ | 🟢 推荐 |
| **lint-staged** | 增量检查 | ⭐⭐⭐⭐ | 🟢 推荐 |

### 8.2 类型检查

**选型**: 🟢 **TypeScript 5.x (strict mode)**

```json
{
  "compilerOptions": {
    "strict": true,
    "noUncheckedIndexedAccess": true,
    "exactOptionalPropertyTypes": true
  }
}
```

## 9. 性能优化

### 9.1 WASM 后端

**选型对比**:

| 方案 | 性能 | 开发复杂度 | 生态成熟度 | 推荐度 |
|------|------|------------|------------|--------|
| **Rust + wasm-pack** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ | 🟢 推荐 |
| AssemblyScript | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐ | 🟡 备选 |
| C/C++ + Emscripten | ⭐⭐⭐⭐⭐ | ⭐⭐ | ⭐⭐⭐⭐ | 🟡 备选 |

**最终选择**: 🟢 **Rust + wasm-pack**

### 9.2 多线程支持

**选型**: 🟢 **Web Workers + SharedArrayBuffer**
- 浏览器多线程计算
- 大数据量处理优化

## 10. 跨平台适配

### 10.1 运行时兼容

| 运行时 | 支持策略 | 实施复杂度 | 优先级 |
|--------|----------|------------|--------|
| **Node.js** | 原生支持 | ⭐⭐⭐⭐⭐ | 🔴 高 |
| **浏览器** | 原生支持 | ⭐⭐⭐⭐⭐ | 🔴 高 |
| **Deno** | 适配层 | ⭐⭐⭐⭐ | 🟡 中 |
| **Bun** | 适配层 | ⭐⭐⭐⭐ | 🟡 中 |
| **React Native** | Polyfill | ⭐⭐⭐ | 🟢 低 |

### 10.2 Polyfill 策略

```typescript
// 条件导入 polyfill
const crypto = (() => {
  if (typeof globalThis.crypto !== 'undefined') {
    return globalThis.crypto;
  }
  if (typeof require !== 'undefined') {
    return require('crypto').webcrypto;
  }
  throw new Error('No crypto implementation available');
})();
```

## 11. 依赖管理策略

### 11.1 核心依赖 (必需)

| 依赖 | 版本 | 用途 | 风险评级 |
|------|------|------|----------|
| **TypeScript** | ^5.0.0 | 开发语言 | 🟢 低 |
| **big-integer** | ^1.6.0 | 大数运算 | 🟢 低 |
| **buffer** | ^6.0.0 | Buffer polyfill | 🟢 低 |

### 11.2 开发依赖

| 依赖 | 版本 | 用途 | 可替代性 |
|------|------|------|----------|
| **tsup** | ^8.0.0 | 构建工具 | 🟡 中 |
| **vitest** | ^1.0.0 | 测试框架 | 🟡 中 |
| **eslint** | ^8.0.0 | 代码检查 | 🟢 高 |
| **prettier** | ^3.0.0 | 代码格式化 | 🟢 高 |
| **typedoc** | ^0.25.0 | 文档生成 | 🟢 高 |

### 11.3 可选依赖 (性能增强)

| 依赖 | 用途 | 加载策略 |
|------|------|----------|
| **@yggjs/wasm** | WASM 后端 | 动态导入 |
| **@yggjs/native** | 原生插件 | 条件加载 |

## 12. 安全相关选型

### 12.1 随机数生成

**选型策略**: 🟢 **平台原生 API**

```typescript
// 优先级: crypto.getRandomValues > crypto.randomBytes > 降级方案
const getRandomBytes = (length: number): Uint8Array => {
  if (typeof crypto !== 'undefined' && crypto.getRandomValues) {
    const buffer = new Uint8Array(length);
    crypto.getRandomValues(buffer);
    return buffer;
  }

  if (typeof require !== 'undefined') {
    const nodeCrypto = require('crypto');
    return new Uint8Array(nodeCrypto.randomBytes(length));
  }

  throw new Error('No secure random source available');
};
```

### 12.2 内存安全

**选型**: 🔴 **自研内存管理**

```typescript
// 安全内存清零
class SecureBuffer {
  private buffer: Uint8Array;

  constructor(size: number) {
    this.buffer = new Uint8Array(size);
  }

  destroy(): void {
    // 多次覆写确保清零
    this.buffer.fill(0);
    this.buffer.fill(0xFF);
    this.buffer.fill(0);
  }
}
```

## 13. 监控与调试

### 13.1 性能监控

**选型**: 🟢 **自研基准测试 + 第三方监控**

| 工具 | 用途 | 集成复杂度 |
|------|------|------------|
| **Benchmark.js** | 性能基准 | ⭐⭐⭐⭐ |
| **Performance API** | 运行时监控 | ⭐⭐⭐⭐⭐ |
| **Web Vitals** | 用户体验监控 | ⭐⭐⭐⭐ |

### 13.2 错误追踪

**选型**: 🟢 **Sentry (可选)**
- 生产环境错误收集
- 性能监控
- 用户反馈收集

## 14. 国际化与本地化

### 14.1 错误消息

**选型**: 🟢 **自研多语言支持**

```typescript
const ErrorMessages = {
  'zh-CN': {
    INVALID_KEY: '无效的密钥格式',
    INVALID_SIGNATURE: '签名验证失败'
  },
  'en-US': {
    INVALID_KEY: 'Invalid key format',
    INVALID_SIGNATURE: 'Signature verification failed'
  }
};
```

## 15. 版本管理与发布

### 15.1 版本控制

**选型**: 🟢 **Semantic Versioning + Conventional Commits**

| 工具 | 用途 | 推荐度 |
|------|------|--------|
| **standard-version** | 自动版本管理 | 🟢 推荐 |
| **changeset** | Monorepo 版本管理 | 🟡 备选 |
| **semantic-release** | 自动发布 | 🟡 备选 |

### 15.2 发布策略

```json
{
  "scripts": {
    "release": "standard-version",
    "release:alpha": "standard-version --prerelease alpha",
    "release:beta": "standard-version --prerelease beta"
  }
}
```

## 16. 最终技术选型总结

### 16.1 核心技术栈

```typescript
// 最终技术选型清单
const TechStack = {
  // 核心实现
  language: 'TypeScript 5.x',
  algorithms: '自研 SM2/SM3/SM4',
  math: '原生 BigInt + big-integer',

  // 构建工具
  bundler: 'tsup + rollup',
  packageManager: 'pnpm',

  // 测试框架
  unitTest: 'Vitest',
  e2eTest: 'Playwright',

  // 文档工具
  apiDocs: 'TypeDoc',
  userDocs: 'VitePress',

  // 代码质量
  linter: 'ESLint',
  formatter: 'Prettier',

  // 性能优化
  wasm: 'Rust + wasm-pack',
  workers: 'Web Workers',

  // 跨平台
  polyfills: '条件加载',
  adapters: '运行时适配层'
};
```

### 16.2 实施路线图

**Phase 1 (MVP - 4周)**:
- ✅ 核心算法自研实现
- ✅ 基础工具链搭建
- ✅ 单元测试覆盖

**Phase 2 (优化 - 6周)**:
- ✅ WASM 后端集成
- ✅ 跨平台适配完善
- ✅ 性能基准测试

**Phase 3 (生产 - 8周)**:
- ✅ 文档完善
- ✅ CI/CD 流程
- ✅ 跨语言兼容性测试

### 16.3 风险评估与缓解

| 风险类型 | 风险等级 | 缓解措施 |
|----------|----------|----------|
| **算法正确性** | 🔴 高 | 权威测试向量 + 交叉验证 |
| **性能瓶颈** | 🟡 中 | WASM 后端 + 性能监控 |
| **兼容性问题** | 🟡 中 | 多环境测试矩阵 |
| **依赖风险** | 🟢 低 | 最小化依赖 + 定期更新 |
| **安全漏洞** | 🔴 高 | 代码审计 + 安全测试 |

### 16.4 成本效益分析

**开发成本**:
- 自研算法: 高 (但必需)
- 工具链集成: 低 (成熟方案)
- 测试覆盖: 中 (自动化)
- 文档编写: 中 (工具辅助)

**长期收益**:
- ✅ 完全自主可控
- ✅ 跨语言生态兼容
- ✅ 高性能优化空间
- ✅ 安全性保障

## 17. 决策建议

基于以上分析，推荐采用 **"核心自研 + 工具链复用"** 的混合策略：

### 17.1 必须自研
- 🔴 SM2/SM3/SM4 核心算法
- 🔴 椭圆曲线运算
- 🔴 安全相关功能

### 17.2 优先复用
- 🟢 构建工具链
- 🟢 测试框架
- 🟢 文档工具
- 🟢 开发工具

### 17.3 混合方案
- 🟡 数学基础库 (原生 + 第三方)
- 🟡 性能优化 (自研 + WASM)
- 🟡 跨平台适配 (适配层 + polyfill)

这种策略既保证了核心功能的安全性和可控性，又充分利用了现有生态的成熟工具，在开发效率和技术风险之间取得了最佳平衡。

---

**文档版本**: v1.0
**最后更新**: 2025-08-15
