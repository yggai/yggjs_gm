## 里程碑 v0.1 — 工作分解结构（WBS）与预估

范围（Scope）：
- 实现 SM3 摘要（不含 HMAC）
- 实现 SM4 的 CBC/CTR 模式（PKCS7/None 填充），含基本参数校验
- 随机数封装（Web/Node）
- 基础密钥导入/导出：对称密钥（SM4）raw/JWK
- 基础工程化：构建、类型、Lint、测试、CI、文档与示例

假设（Assumptions）：
- 以 TypeScript 为主，Node LTS 与现代浏览器为目标；RN 兼容性验证延后
- API 以 Promise 异步为主，数据 IO 统一 Uint8Array；提供少量便捷工具
- 单元测试覆盖率目标 v0.1 ≥ 85%（v0.2 提升到 ≥ 90%）

### 1. 工程与基础设施（共 ~3.0 人日）
1.1 仓库与工程脚手架（0.5d）
- 初始化 TS 项目（tsconfig strict）、ESLint+Prettier、编辑器配置
- 目录结构：src/{sm3,sm4,random,key,util}, tests, docs, examples
- 依赖管理与脚本：pnpm/npm/yarn 二选一（默认 pnpm）

1.2 构建与打包（0.8d）
- 选择 tsup/rollup，输出 ESM + CJS + d.ts
- package.json exports/typings/sideEffects 配置；浏览器/Node 条件导出
- Tree-shaking 验证与最小化产物体积基线

1.3 CI 与质量门禁（0.9d）
- GitHub Actions：安装缓存、lint、build、test（Node 18/20）
- 覆盖率采集与阈值（≥ 85%）
- 变更集检测（仅增量测试）与 Badge

1.4 基础文档与示例骨架（0.8d）
- README 快速开始；docs 目录结构；Typedoc 基础配置
- examples：Node 示例（SM3、SM4-CBC/CTR），Vite 浏览器示例（最小化）

依赖：无；输出：工程可构建、CI 通过、基础文档与示例可运行
风险：打包兼容性（浏览器/Node 条件导出），通过示例与 CI 验证

### 2. 通用工具与随机数（共 ~1.4 人日）
2.1 随机数封装（0.5d）
- Web：crypto.getRandomValues；Node：crypto.randomBytes
- 能力探测与统一 API：random.bytes(len): Promise<Uint8Array>

2.2 字节与编码工具（0.6d）
- hex/base64 编解码；UTF-8 字符串与 Uint8Array 转换
- 安全注意：避免不必要的复制；输入校验

2.3 最小常数时间工具（0.3d）
- constTimeEqual(a,b) 用于测试与基础比较

依赖：1.x 完成
输出：src/random 与 src/util 可复用
风险：浏览器 polyfill 体积控制

### 3. SM3 摘要（共 ~2.2 人日）
3.1 算法实现（1.0d）
- 压缩函数、消息扩展、分块处理
- API：sm3.digest(data: Uint8Array): Promise<Uint8Array>

3.2 流式接口（0.6d）
- Hasher：update(...).digest()；用于大数据

3.3 测试与向量（0.6d）
- 标准测试向量；边界：空输入、巨大输入、分块一致性

依赖：2.x 完成
输出：sm3 稳定实现与测试
风险：性能达标性；提供基准脚本，必要时优化内存访问

### 4. SM4（CBC/CTR）（共 ~3.6 人日）
4.1 核心分组算法（1.2d）
- Key schedule、加解密单块；查表优化与可读性权衡

4.2 模式与填充（1.2d）
- CBC：PKCS7 默认；支持 None（需对齐 16 字节）
- CTR：无填充；计数器起点与 IV/nonce 规范
- 参数校验：IV 长度 16、key 长度 16、数据长度规则

4.3 API 与流式（0.6d）
- sm4.encrypt/decrypt(key, iv, data, {mode, padding})
- 流式/分片解密（最小支持，便于大数据场景）

4.4 测试与向量（0.6d）
- 标准/公开向量；CBC/CTR 跨实现比对
- 边界：零长度、非对齐、错误 IV/Key、None 填充错误路径

依赖：2.x 完成（util、random）；与 3.x 并行可行
输出：sm4 CBC/CTR 可用实现，覆盖关键边界
风险：模式实现细节与兼容性；通过测试向量与交叉验证缓解

### 5. 密钥导入/导出（对称）（共 ~1.2 人日）
5.1 原始/字节与 JWK（0.8d）
- importSymmetric('raw'|'jwk'), exportSymmetric('raw'|'jwk')
- JWK(kty:'oct', alg:'SM4', k:base64url)

5.2 错误与校验（0.4d）
- key 长度、JWK 必备字段、base64url 校验

依赖：2.x 完成
输出：key 模块；与 sm4 联调
风险：JWK 兼容性与字段约定，文档说明

### 6. 文档与开发者体验（共 ~1.6 人日）
6.1 快速开始与用法（0.6d）
- SM3、SM4 CBC/CTR 的最小示例；安全注意事项（IV 唯一性、ECB 风险说明）

6.2 API 参考生成（0.5d）
- TSDoc 注释与 Typedoc 输出；docs 链接打通

6.3 示例与 FAQ（0.5d）
- Node 与浏览器示例细化；常见错误与提示

依赖：核心模块基本完成
输出：开发者能在 10 分钟内跑通 Demo
风险：示例与打包器兼容性

### 7. 测试与发布准备（共 ~1.8 人日）
7.1 覆盖率冲刺（0.8d）
- 重点补齐错误分支、边界条件

7.2 基准测试与调优（0.6d）
- 基于 Node/浏览器的基线性能报告；记录方法与硬件

7.3 版本与发布脚本（0.4d）
- 语义化版本、变更日志、npm 发布 dry-run（不真正发布）

依赖：3、4、5、6 基本完成
输出：可发布包（内部验证）
风险：不同环境差异导致的测试不稳定

---

总体预估：工程 3.0 + 工具与 RNG 1.4 + SM3 2.2 + SM4 3.6 + 密钥 1.2 + 文档 DX 1.6 + 测试发布 1.8 ≈ 14.8 人日

建议排期（4–6 周，1 人全职）：
- Week 1：模块化工程（1.x）、工具与 RNG（2.x）、SM3 算法实现（3.1）
- Week 2：SM3 流式与测试（3.2/3.3）、SM4 核心（4.1）
- Week 3：SM4 模式与填充（4.2）、API/流式（4.3）
- Week 4：SM4 测试与向量（4.4）、密钥导入导出（5.x）
- Week 5：文档与 DX（6.x）、覆盖率冲刺与基准（7.1/7.2）
- Week 6：打磨、示例完善、发布演练（7.3）

关键路径（Critical Path）：1.x → 2.x → 3.x/4.x → 5.x → 6.x → 7.x

主要风险与缓解：
- 性能不达标：优先保证正确性，记录瓶颈；必要时预研 WASM 路线
- 打包兼容：双目标构建+示例仓库验证；CI 增加浏览器打包检查
- 安全误用：文档中强化 IV 唯一性、填充与对齐规则；默认安全参数

