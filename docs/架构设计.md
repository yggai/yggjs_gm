# 国密算法 TypeScript 库架构设计

- **文档版本**: v1.0
- **撰写角色**: 前端架构师
- **面向读者**: 技术负责人、核心开发者、架构师
- **更新时间**: 2025-08-15

## 1. 架构概览

### 1.1 设计原则

- **分层解耦**: 核心算法、运行时适配、API 层清晰分离
- **可扩展性**: 支持多种后端实现（纯 JS、WASM、Native）
- **跨平台**: 统一 API 支持 Node.js、浏览器、Deno、Bun、React Native
- **类型安全**: 完整的 TypeScript 类型系统，编译时错误检查
- **性能优先**: 零拷贝设计、内存池、批处理 API
- **安全第一**: 常数时间算法、内存清零、安全随机数
- **标准兼容**: 与 yggpy_gm、ygggo_gm 完全互操作

### 1.2 整体架构图

```
┌─────────────────────────────────────────────────────────┐
│                    应用层 API                            │
├─────────────────────────────────────────────────────────┤
│  gm.sm2.*  │  gm.sm3.*  │  gm.sm4.*  │  gm.key.*  │ ... │
├─────────────────────────────────────────────────────────┤
│                   统一 API 层                            │
├─────────────────────────────────────────────────────────┤
│           运行时适配层 (Runtime Adapters)                │
├─────────────────────────────────────────────────────────┤
│  Node.js   │  Browser   │   Deno    │   Bun    │   RN   │
├─────────────────────────────────────────────────────────┤
│              后端选择层 (Backend Strategy)               │
├─────────────────────────────────────────────────────────┤
│   纯 JS    │   WASM     │  Native   │  WebCrypto │ ...  │
├─────────────────────────────────────────────────────────┤
│                  核心算法层                              │
├─────────────────────────────────────────────────────────┤
│    SM2     │    SM3     │    SM4    │   Math    │ Utils │
└─────────────────────────────────────────────────────────┘
```

## 2. 技术栈选择

### 2.1 核心技术

| 技术领域 | 选择 | 版本 | 理由 |
|---------|------|------|------|
| 开发语言 | TypeScript | 5.x | 强类型、现代语法、工具链成熟 |
| 构建工具 | tsup + rollup | latest | tsup 快速开发，rollup 精细打包 |
| 测试框架 | Vitest | latest | 快速、现代、与 Vite 生态集成 |
| E2E 测试 | Playwright | latest | 跨浏览器、跨平台支持 |
| 文档生成 | TypeDoc + VitePress | latest | API 文档 + 用户文档 |
| 代码质量 | ESLint + Prettier | latest | 代码规范和格式化 |
| 包管理器 | pnpm | latest | 性能优异、节省磁盘空间 |

### 2.2 运行时支持

```typescript
// 运行时能力探测
interface RuntimeCapabilities {
  crypto: 'node' | 'webcrypto' | 'polyfill';
  bigint: boolean;
  wasm: boolean;
  worker: boolean;
  streams: boolean;
}
```

### 2.3 性能后端

- **纯 JavaScript**: 默认实现，兼容性最佳
- **WebAssembly**: Rust 实现，高性能计算
- **Node.js Native**: C++ 插件，企业级性能
- **WebCrypto**: 浏览器原生加速（部分算法）

## 3. 模块结构设计

### 3.1 目录结构

```
src/
├── core/                    # 核心算法实现
│   ├── sm2/
│   │   ├── index.ts        # SM2 主入口
│   │   ├── keypair.ts      # 密钥对生成
│   │   ├── sign.ts         # 数字签名
│   │   ├── encrypt.ts      # 公钥加密
│   │   └── curve.ts        # 椭圆曲线参数
│   ├── sm3/
│   │   ├── index.ts        # SM3 主入口
│   │   ├── digest.ts       # 摘要算法
│   │   └── hmac.ts         # HMAC-SM3
│   ├── sm4/
│   │   ├── index.ts        # SM4 主入口
│   │   ├── cipher.ts       # 分组密码
│   │   ├── modes.ts        # 工作模式
│   │   └── padding.ts      # 填充算法
│   └── math/
│       ├── bigint.ts       # 大整数运算
│       ├── modular.ts      # 模运算
│       ├── ecc.ts          # 椭圆曲线
│       └── random.ts       # 安全随机数
├── adapters/                # 运行时适配器
│   ├── node.ts             # Node.js 适配
│   ├── browser.ts          # 浏览器适配
│   ├── deno.ts             # Deno 适配
│   ├── bun.ts              # Bun 适配
│   └── react-native.ts     # React Native 适配
├── backends/                # 可插拔后端
│   ├── js/                 # 纯 JS 实现
│   ├── wasm/               # WASM 实现
│   └── native/             # 原生实现
├── api/                     # 高级 API
│   ├── sm2.ts              # SM2 API
│   ├── sm3.ts              # SM3 API
│   ├── sm4.ts              # SM4 API
│   ├── key.ts              # 密钥管理 API
│   └── random.ts           # 随机数 API
├── utils/                   # 工具函数
│   ├── encoding.ts         # 编码转换
│   ├── validation.ts       # 输入验证
│   ├── errors.ts           # 错误处理
│   └── constants.ts        # 常量定义
├── types/                   # 类型定义
│   ├── algorithms.ts       # 算法类型
│   ├── keys.ts             # 密钥类型
│   └── common.ts           # 通用类型
└── index.ts                 # 主入口
```

### 3.2 包结构设计

```
packages/
├── core/                    # 核心包
├── node/                    # Node.js 专用包
├── browser/                 # 浏览器专用包
├── wasm/                    # WASM 后端包
└── native/                  # 原生插件包
```

## 4. 核心算法层设计

### 4.1 SM2 椭圆曲线实现

```typescript
// 椭圆曲线参数 (sm2p256v1)
export const SM2_CURVE = {
  p: 0xFFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFFn,
  a: 0xFFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFCn,
  b: 0x28E9FA9E9D9F5E344D5A9E4BCF6509A7F39789F515AB8F92DDDCBDEEn,
  n: 0xFFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFF7203DF6B21C6052B53BBF40939D54123n,
  gx: 0x32C4AE2C1F1981195F9904466A39C9948FE30BBFF2660BE1715A4589334C74C7n,
  gy: 0xBC3736A2F4F6779C59BDCEE36B692153D0A9877CC62A474002DF32E52139F0A0n
};

// 点运算实现
class ECPoint {
  constructor(public x: bigint, public y: bigint) {}
  
  add(other: ECPoint): ECPoint { /* 椭圆曲线点加法 */ }
  multiply(scalar: bigint): ECPoint { /* 标量乘法 */ }
  isOnCurve(): boolean { /* 验证点是否在曲线上 */ }
}
```

### 4.2 SM3 哈希算法实现

```typescript
export class SM3 {
  private state: Uint32Array;
  private buffer: Uint8Array;
  private length: number;

  constructor() {
    this.reset();
  }

  update(data: Uint8Array): this {
    // 分块处理输入数据
    return this;
  }

  digest(): Uint8Array {
    // 输出 256 位摘要
    return new Uint8Array(32);
  }

  private compress(block: Uint8Array): void {
    // SM3 压缩函数实现
  }
}
```

### 4.3 SM4 分组密码实现

```typescript
export class SM4 {
  private roundKeys: Uint32Array;

  constructor(key: Uint8Array) {
    this.roundKeys = this.keyExpansion(key);
  }

  encryptBlock(plaintext: Uint8Array): Uint8Array {
    // 单块加密
    return new Uint8Array(16);
  }

  decryptBlock(ciphertext: Uint8Array): Uint8Array {
    // 单块解密
    return new Uint8Array(16);
  }

  private keyExpansion(key: Uint8Array): Uint32Array {
    // 密钥扩展算法
    return new Uint32Array(32);
  }
}
```

## 5. 运行时适配层

### 5.1 能力探测机制

```typescript
export class RuntimeDetector {
  static detect(): RuntimeCapabilities {
    return {
      crypto: this.detectCrypto(),
      bigint: typeof BigInt !== 'undefined',
      wasm: typeof WebAssembly !== 'undefined',
      worker: typeof Worker !== 'undefined',
      streams: typeof ReadableStream !== 'undefined'
    };
  }

  private static detectCrypto(): 'node' | 'webcrypto' | 'polyfill' {
    if (typeof process !== 'undefined' && process.versions?.node) {
      return 'node';
    }
    if (typeof crypto !== 'undefined' && crypto.subtle) {
      return 'webcrypto';
    }
    return 'polyfill';
  }
}
```

### 5.2 后端选择策略

```typescript
export class BackendSelector {
  static selectBest(capabilities: RuntimeCapabilities): Backend {
    // 性能优先级: Native > WASM > WebCrypto > Pure JS
    if (capabilities.native) return new NativeBackend();
    if (capabilities.wasm) return new WasmBackend();
    if (capabilities.webcrypto) return new WebCryptoBackend();
    return new PureJSBackend();
  }
}
```

## 6. API 设计层

### 6.1 统一 API 接口

```typescript
// 主入口 API 设计
export const gm = {
  sm2: {
    generateKeyPair(): Promise<SM2KeyPair>,
    sign(privateKey: SM2PrivateKey, data: Uint8Array, options?: SignOptions): Promise<Uint8Array>,
    verify(publicKey: SM2PublicKey, data: Uint8Array, signature: Uint8Array, options?: VerifyOptions): Promise<boolean>,
    encrypt(publicKey: SM2PublicKey, plaintext: Uint8Array, options?: EncryptOptions): Promise<Uint8Array>,
    decrypt(privateKey: SM2PrivateKey, ciphertext: Uint8Array, options?: DecryptOptions): Promise<Uint8Array>
  },
  sm3: {
    digest(data: Uint8Array): Promise<Uint8Array>,
    hmac(key: Uint8Array, data: Uint8Array): Promise<Uint8Array>,
    createHash(): SM3Hash
  },
  sm4: {
    encrypt(key: Uint8Array, iv: Uint8Array, data: Uint8Array, options: SM4Options): Promise<Uint8Array>,
    decrypt(key: Uint8Array, iv: Uint8Array, data: Uint8Array, options: SM4Options): Promise<Uint8Array>,
    createCipher(key: Uint8Array, options: SM4Options): SM4Cipher
  },
  key: {
    generate(algorithm: KeyAlgorithm): Promise<CryptoKey>,
    import(format: KeyFormat, keyData: Uint8Array, algorithm: KeyAlgorithm): Promise<CryptoKey>,
    export(format: KeyFormat, key: CryptoKey): Promise<Uint8Array>
  },
  random: {
    bytes(length: number): Uint8Array,
    int(min: number, max: number): number,
    bigint(bitLength: number): bigint
  }
};
```

### 6.2 类型系统设计

```typescript
// 核心类型定义
export interface SM2KeyPair {
  privateKey: SM2PrivateKey;
  publicKey: SM2PublicKey;
}

export interface SM2PrivateKey {
  algorithm: 'SM2';
  d: bigint;
  publicKey?: SM2PublicKey;
}

export interface SM2PublicKey {
  algorithm: 'SM2';
  x: bigint;
  y: bigint;
}

export interface SM4Options {
  mode: 'ECB' | 'CBC' | 'CTR' | 'CFB' | 'OFB';
  padding: 'PKCS7' | 'None' | 'Zero';
}

export interface SignOptions {
  hash?: 'SM3';
  encoding?: 'DER' | 'RS';
  userId?: Uint8Array;
}
```

### 6.3 错误处理机制

```typescript
export class GmError extends Error {
  constructor(
    public code: string,
    message: string,
    public cause?: Error
  ) {
    super(message);
    this.name = 'GmError';
  }
}

export const ErrorCodes = {
  INVALID_KEY: 'INVALID_KEY',
  INVALID_SIGNATURE: 'INVALID_SIGNATURE',
  INVALID_CIPHERTEXT: 'INVALID_CIPHERTEXT',
  UNSUPPORTED_ALGORITHM: 'UNSUPPORTED_ALGORITHM',
  RUNTIME_NOT_SUPPORTED: 'RUNTIME_NOT_SUPPORTED'
} as const;
```

## 7. 构建与打包策略

### 7.1 构建配置

```typescript
// tsup.config.ts
export default defineConfig({
  entry: {
    index: 'src/index.ts',
    node: 'src/adapters/node.ts',
    browser: 'src/adapters/browser.ts'
  },
  format: ['esm', 'cjs'],
  dts: true,
  clean: true,
  splitting: true,
  treeshake: true,
  minify: process.env.NODE_ENV === 'production',
  target: ['es2020', 'node16'],
  platform: 'neutral'
});
```

### 7.2 包导出策略

```json
{
  "name": "yggjs-gm",
  "type": "module",
  "exports": {
    ".": {
      "types": "./dist/index.d.ts",
      "import": "./dist/index.js",
      "require": "./dist/index.cjs"
    },
    "./node": {
      "types": "./dist/node.d.ts",
      "import": "./dist/node.js",
      "require": "./dist/node.cjs"
    },
    "./browser": {
      "types": "./dist/browser.d.ts",
      "import": "./dist/browser.js"
    }
  },
  "sideEffects": false
}
```

### 7.3 Tree-shaking 优化

```typescript
// 支持按需导入
export { sm2 } from './api/sm2';
export { sm3 } from './api/sm3';
export { sm4 } from './api/sm4';
export { key } from './api/key';
export { random } from './api/random';

// 用户可以按需导入
import { sm2, sm3 } from 'yggjs-gm';
```

## 8. 性能优化策略

### 8.1 内存管理

```typescript
// 对象池模式减少 GC 压力
class Uint8ArrayPool {
  private pool: Uint8Array[] = [];

  acquire(size: number): Uint8Array {
    const buffer = this.pool.pop() || new Uint8Array(size);
    return buffer.length >= size ? buffer.subarray(0, size) : new Uint8Array(size);
  }

  release(buffer: Uint8Array): void {
    buffer.fill(0); // 安全清零
    this.pool.push(buffer);
  }
}
```

### 8.2 批处理 API

```typescript
// 批量操作减少函数调用开销
export interface BatchOperations {
  sm2: {
    signBatch(privateKey: SM2PrivateKey, dataList: Uint8Array[]): Promise<Uint8Array[]>;
    verifyBatch(publicKey: SM2PublicKey, dataList: Uint8Array[], signatures: Uint8Array[]): Promise<boolean[]>;
  };
  sm4: {
    encryptBatch(key: Uint8Array, dataList: Uint8Array[], options: SM4Options): Promise<Uint8Array[]>;
  };
}
```

### 8.3 WASM 集成

```typescript
// WASM 后端接口
export interface WasmBackend {
  sm2_sign(privateKey: Uint8Array, data: Uint8Array): Uint8Array;
  sm2_verify(publicKey: Uint8Array, data: Uint8Array, signature: Uint8Array): boolean;
  sm3_digest(data: Uint8Array): Uint8Array;
  sm4_encrypt(key: Uint8Array, iv: Uint8Array, data: Uint8Array, mode: number): Uint8Array;
}

// 动态加载 WASM
async function loadWasm(): Promise<WasmBackend> {
  const wasmModule = await import('./wasm/yggjs_gm_bg.wasm');
  return wasmModule;
}
```

## 9. 安全设计

### 9.1 常数时间算法

```typescript
// 常数时间比较函数
function constantTimeEqual(a: Uint8Array, b: Uint8Array): boolean {
  if (a.length !== b.length) return false;

  let result = 0;
  for (let i = 0; i < a.length; i++) {
    result |= a[i] ^ b[i];
  }
  return result === 0;
}

// 常数时间条件选择
function constantTimeSelect(condition: number, a: bigint, b: bigint): bigint {
  const mask = BigInt(condition) - 1n;
  return (a & mask) | (b & ~mask);
}
```

### 9.2 内存安全

```typescript
// 敏感数据清零
class SecureBuffer {
  private buffer: Uint8Array;

  constructor(size: number) {
    this.buffer = new Uint8Array(size);
  }

  destroy(): void {
    this.buffer.fill(0);
    // @ts-ignore
    this.buffer = null;
  }

  get data(): Uint8Array {
    return this.buffer;
  }
}
```

### 9.3 安全随机数

```typescript
export class SecureRandom {
  static bytes(length: number): Uint8Array {
    const buffer = new Uint8Array(length);

    if (typeof crypto !== 'undefined' && crypto.getRandomValues) {
      crypto.getRandomValues(buffer);
    } else if (typeof require !== 'undefined') {
      const nodeCrypto = require('crypto');
      const randomBytes = nodeCrypto.randomBytes(length);
      buffer.set(randomBytes);
    } else {
      throw new GmError('RUNTIME_NOT_SUPPORTED', 'No secure random source available');
    }

    return buffer;
  }
}
```

## 10. 跨语言兼容性设计

### 10.1 数据格式标准化

```typescript
// 统一的编码格式
export const EncodingFormats = {
  // 密钥格式
  JWK: 'jwk',
  PEM: 'pem',
  DER: 'der',
  PKCS8: 'pkcs8',
  SPKI: 'spki',

  // 数据编码
  HEX: 'hex',
  BASE64: 'base64',
  BASE64URL: 'base64url',
  BINARY: 'binary'
} as const;

// SM2 签名格式 (与 Python/Go 版本保持一致)
export interface SM2SignatureFormat {
  encoding: 'DER' | 'RS';  // DER: ASN.1 编码, RS: r||s 拼接
  r: Uint8Array;
  s: Uint8Array;
}

// SM2 加密格式 (C1C2C3 vs C1C3C2)
export interface SM2CiphertextFormat {
  mode: 'C1C2C3' | 'C1C3C2';
  c1: Uint8Array;  // 椭圆曲线点
  c2: Uint8Array;  // 密文
  c3: Uint8Array;  // 摘要
}
```

### 10.2 算法参数统一

```typescript
// 与 yggpy_gm、ygggo_gm 保持一致的默认参数
export const CrossLanguageDefaults = {
  SM2: {
    curve: 'sm2p256v1',
    hash: 'SM3',
    signatureEncoding: 'DER',
    ciphertextMode: 'C1C2C3',
    userId: new Uint8Array([
      0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38,
      0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38
    ]) // 默认用户ID: "1234567812345678"
  },
  SM3: {
    outputLength: 32
  },
  SM4: {
    blockSize: 16,
    keySize: 16,
    defaultMode: 'CBC',
    defaultPadding: 'PKCS7'
  }
};
```

### 10.3 测试向量共享

```typescript
// 跨语言测试向量接口
export interface CrossLanguageTestVector {
  algorithm: 'SM2' | 'SM3' | 'SM4';
  operation: string;
  input: {
    [key: string]: string; // hex 编码的输入数据
  };
  expected: {
    [key: string]: string; // hex 编码的期望输出
  };
  metadata: {
    source: string;
    version: string;
    description: string;
  };
}

// 从共享测试向量文件加载
export async function loadSharedTestVectors(): Promise<CrossLanguageTestVector[]> {
  // 从 GitHub 或 CDN 加载共享的测试向量
  const response = await fetch('https://raw.githubusercontent.com/yggdrasil-gm/test-vectors/main/vectors.json');
  return response.json();
}
```

### 10.4 版本同步机制

```typescript
// 跨语言版本兼容性检查
export interface CompatibilityMatrix {
  yggjs_gm: string;
  yggpy_gm: string;
  ygggo_gm: string;
  testVectors: string;
  specification: string;
}

export async function checkCompatibility(): Promise<CompatibilityMatrix> {
  // 检查当前版本与其他语言版本的兼容性
  const response = await fetch('https://api.yggdrasil-gm.org/compatibility');
  return response.json();
}
```

## 11. 开发工具链

### 11.1 开发环境配置

```json
// .vscode/settings.json
{
  "typescript.preferences.importModuleSpecifier": "relative",
  "editor.formatOnSave": true,
  "editor.codeActionsOnSave": {
    "source.fixAll.eslint": true
  },
  "files.associations": {
    "*.wasm": "binary"
  }
}

// .vscode/extensions.json
{
  "recommendations": [
    "ms-vscode.vscode-typescript-next",
    "esbenp.prettier-vscode",
    "dbaeumer.vscode-eslint",
    "ms-vscode.test-adapter-converter"
  ]
}
```

### 11.2 代码质量配置

```javascript
// eslint.config.js
export default [
  {
    files: ['src/**/*.ts'],
    languageOptions: {
      parser: '@typescript-eslint/parser',
      parserOptions: {
        project: './tsconfig.json'
      }
    },
    plugins: {
      '@typescript-eslint': typescriptEslint,
      'security': security
    },
    rules: {
      '@typescript-eslint/no-explicit-any': 'error',
      '@typescript-eslint/prefer-readonly': 'error',
      'security/detect-object-injection': 'error',
      'no-console': 'warn'
    }
  }
];
```

### 11.3 测试配置

```typescript
// vitest.config.ts
export default defineConfig({
  test: {
    globals: true,
    environment: 'node',
    coverage: {
      provider: 'v8',
      reporter: ['text', 'json', 'html'],
      threshold: {
        global: {
          branches: 90,
          functions: 90,
          lines: 90,
          statements: 90
        }
      }
    },
    testTimeout: 30000,
    hookTimeout: 30000
  }
});
```

## 12. CI/CD 流程

### 12.1 GitHub Actions 配置

```yaml
# .github/workflows/ci.yml
name: CI
on: [push, pull_request]

jobs:
  test:
    strategy:
      matrix:
        node-version: [18, 20, 22]
        os: [ubuntu-latest, windows-latest, macos-latest]

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v2
        with:
          version: latest

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Type check
        run: pnpm type-check

      - name: Lint
        run: pnpm lint

      - name: Test
        run: pnpm test:coverage

      - name: Build
        run: pnpm build

      - name: E2E Test
        run: pnpm test:e2e

  cross-language-test:
    runs-on: ubuntu-latest
    steps:
      - name: Test with yggpy_gm
        run: |
          # 安装 Python 版本并运行互操作测试
          pip install yggpy-gm
          pnpm test:cross-python

      - name: Test with ygggo_gm
        run: |
          # 安装 Go 版本并运行互操作测试
          go install github.com/yggdrasil-gm/ygggo-gm
          pnpm test:cross-go
```

### 12.2 发布流程

```yaml
# .github/workflows/release.yml
name: Release
on:
  push:
    tags: ['v*']

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build and publish
        run: |
          pnpm build
          pnpm changeset publish
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
```

## 13. 监控与维护

### 13.1 性能监控

```typescript
// 性能基准测试
export class PerformanceBenchmark {
  static async runBenchmarks(): Promise<BenchmarkResults> {
    const results = {
      sm2: await this.benchmarkSM2(),
      sm3: await this.benchmarkSM3(),
      sm4: await this.benchmarkSM4()
    };

    // 上报到监控系统
    await this.reportResults(results);
    return results;
  }

  private static async benchmarkSM3(): Promise<SM3BenchmarkResult> {
    const data = new Uint8Array(1024 * 1024); // 1MB
    const iterations = 100;

    const start = performance.now();
    for (let i = 0; i < iterations; i++) {
      await gm.sm3.digest(data);
    }
    const end = performance.now();

    const throughput = (data.length * iterations) / ((end - start) / 1000) / 1024 / 1024; // MB/s
    return { throughput, iterations, dataSize: data.length };
  }
}
```

### 13.2 错误追踪

```typescript
// 错误上报机制
export class ErrorReporter {
  static report(error: GmError, context: ErrorContext): void {
    const report = {
      error: {
        code: error.code,
        message: error.message,
        stack: error.stack
      },
      context: {
        runtime: this.detectRuntime(),
        version: this.getVersion(),
        userAgent: typeof navigator !== 'undefined' ? navigator.userAgent : undefined,
        ...context
      },
      timestamp: new Date().toISOString()
    };

    // 发送到错误追踪服务
    this.sendReport(report);
  }
}
```

## 14. 扩展性设计

### 14.1 插件机制

```typescript
// 插件接口定义
export interface GmPlugin {
  name: string;
  version: string;
  install(gm: GmInstance): void;
  uninstall?(gm: GmInstance): void;
}

// 插件管理器
export class PluginManager {
  private plugins = new Map<string, GmPlugin>();

  register(plugin: GmPlugin): void {
    this.plugins.set(plugin.name, plugin);
    plugin.install(this.gm);
  }

  unregister(name: string): void {
    const plugin = this.plugins.get(name);
    if (plugin?.uninstall) {
      plugin.uninstall(this.gm);
    }
    this.plugins.delete(name);
  }
}
```

### 14.2 后端抽象

```typescript
// 可插拔后端接口
export interface CryptoBackend {
  name: string;
  priority: number;
  isSupported(): boolean;

  // SM2 操作
  sm2Sign(privateKey: Uint8Array, data: Uint8Array): Promise<Uint8Array>;
  sm2Verify(publicKey: Uint8Array, data: Uint8Array, signature: Uint8Array): Promise<boolean>;

  // SM3 操作
  sm3Digest(data: Uint8Array): Promise<Uint8Array>;

  // SM4 操作
  sm4Encrypt(key: Uint8Array, iv: Uint8Array, data: Uint8Array, mode: string): Promise<Uint8Array>;
}

// 后端注册机制
export class BackendRegistry {
  private backends: CryptoBackend[] = [];

  register(backend: CryptoBackend): void {
    this.backends.push(backend);
    this.backends.sort((a, b) => b.priority - a.priority);
  }

  getBest(): CryptoBackend {
    return this.backends.find(b => b.isSupported()) || new PureJSBackend();
  }
}
```

## 15. 总结

本架构设计文档详细描述了 yggjs_gm 国密算法 TypeScript 库的技术实现方案，主要特点包括：

### 15.1 核心优势

- **分层架构**: 清晰的模块分离，便于维护和扩展
- **跨平台支持**: 统一 API 支持多种 JavaScript 运行时
- **高性能**: 多后端支持，从纯 JS 到 WASM 到原生插件
- **类型安全**: 完整的 TypeScript 类型系统
- **安全设计**: 常数时间算法、内存安全、安全随机数
- **跨语言兼容**: 与 Python、Go 版本完全互操作

### 15.2 技术亮点

- 现代化的构建工具链（tsup、Vitest、TypeDoc）
- 智能的运行时适配和后端选择
- 完善的错误处理和性能监控
- 可扩展的插件机制
- 严格的代码质量控制

### 15.3 发展路线

- v0.1: 核心算法实现和基础 API
- v0.2: 跨平台适配和性能优化
- v0.3: WASM 后端和高级功能
- v0.4+: 生态扩展和企业级特性

该架构设计为构建一个现代、高性能、安全的国密算法库提供了坚实的技术基础。

---

**文档版本**: v1.0
**最后更新**: 2025-08-15
```
```
